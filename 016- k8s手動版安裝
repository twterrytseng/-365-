## 手動版安裝

sudo dnf install -y dnf-plugins-core
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 啟用 overlay 與 br_netfilter 模組（容器與 K8s 網路必需）
sudo cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

# 設定 sysctl 讓 Kubernetes 能處理 bridge 流量、IP 轉發
sudo cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward = 1
EOF
sudo sysctl --system




sudo sed -i '/ swap / s/^/#/' /etc/fstab
sudo swapoff -a



sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config


sudo dnf -y install containerd


# 產生預設設定檔
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml > /dev/null

# 將 cgroup 驅動改成 systemd（Kubelet 最佳實踐）
sudo sed -i 's/^\(\s*SystemdCgroup = \).*/\1true/' /etc/containerd/config.toml

# 若使用鏡像加速/私有 registry，可在 [plugins."io.containerd.grpc.v1.cri".registry] 段落新增設定


sudo systemctl daemon-reload
sudo systemctl enable --now containerd
systemctl status containerd --no-pager




cat <<'EOF' | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.30/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.30/rpm/repodata/repomd.xml.key
EOF




sudo dnf -y install kubelet kubeadm kubectl
sudo dnf -y install cri-tools # 常用 CRI 除錯工具（可選）
sudo systemctl enable kubelet

#預設沒有安裝 versionlock 這個外掛
sudo dnf install -y 'dnf-command(versionlock)'  

# 鎖定版本，避免自動更新造成不一致
sudo dnf versionlock add kubelet kubeadm kubectl




# 查看 containerd socket 存在
sudo ls -l /run/containerd/containerd.sock /var/run/containerd/containerd.sock



sudo systemctl stop firewalld
sudo systemctl disable firewalld


# Rocky linux

sudo kubeadm init \
  --pod-network-cidr=172.16.0.0/16 \
  --kubernetes-version=v1.30.0


mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 驗證
kubectl cluster-info
kubectl get nodes


# 先安裝 Tigera Operator (CRDs)
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
kubectl get crds | grep tigera


# 修改 Calico 的網段 ，自定義 172.16.0.0/24
curl https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml -O
kubectl apply -f custom-resources.yaml

# 這會啟動很多網路相關的 Pod
kubectl get pods -n calico-system -w

kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/calico.yaml
# 等待 calico-node 與 calico-kube-controllers 就緒
kubectl -n kube-system get pods -w



3. 正確的健康檢查方式 (SOP)
在 v1.30 版本中，請改用以下三種方式來確認叢集是否真的健康：
kubectl get pods -n kube-system
kubectl get nodes
sudo ss -tlnp | grep -E '10257|10259|6443'


檢查日誌
sudo journalctl -u containerd -f
sudo journalctl -u kubelet -f

