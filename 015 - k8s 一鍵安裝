#!/usr/bin/env bash
# Rocky Linux 8/9 - 終極修正版 K8s 安裝腳本 (v1.30 + Calico Operator)
# 特色：解決了 kubelet 啟動失敗、CRD 過長報錯、以及版本鎖定需求。

set -euo pipefail

### ========= 變數設定 =========
K8S_RPM_BASEURL="https://pkgs.k8s.io/core:/stable:/v1.30/rpm/"
K8S_RPM_GPGKEY="https://pkgs.k8s.io/core:/stable:/v1.30/rpm/repodata/repomd.xml.key"
K8S_VERSION="1.30.0"
POD_CIDR="172.16.0.0/16"
SERVICE_CIDR="10.96.0.0/12"
CALICO_VERSION="v3.27.0"

### ========= 小工具 =========
log(){ echo -e "\033[0;32m[INFO]\033[0m $*"; }
warn(){ echo -e "\033[1;33m[WARN]\033[0m $*"; }
err(){ echo -e "\033[0;31m[ERR ]\033[0m $*"; exit 1; }

[[ "$(id -u)" -eq 0 ]] || err "請以 root 執行"

### ========= 0. 系統更新與工具安裝 =========
log "執行系統更新並安裝必要工具"
dnf -y update
dnf -y install dnf-plugins-core 'dnf-command(versionlock)' \
           curl wget bash-completion iproute iproute-tc jq tar chrony

log "啟動並同步時間 (chronyd)"
systemctl enable --now chronyd || true

### ========= 1. 基礎環境設定 =========
log "環境清理 (Swap, SELinux, 防火牆)"
swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab
setenforce 0 || true
sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config

log "載入 Kernel 模組與優化核心參數"
cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
modprobe overlay && modprobe br_netfilter

cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
sysctl --system
systemctl disable --now firewalld || true

### ========= 2. 安裝 Container Runtime (containerd) =========
log "配置 Docker Repo 並安裝 containerd.io"
dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
dnf -y install containerd.io

log "配置 containerd 使用 SystemdCgroup"
mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml >/dev/null
# 確保正確開啟 SystemdCgroup
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
systemctl restart containerd && systemctl enable containerd

### ========= 3. 安裝 K8s 組件並鎖定版本 =========
log "配置 Kubernetes Repo (v1.30)"
cat <<EOF | tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=${K8S_RPM_BASEURL}
enabled=1
gpgcheck=1
gpgkey=${K8S_RPM_GPGKEY}
EOF

log "安裝並鎖定 kubelet, kubeadm, kubectl 版本"
dnf -y install kubelet kubeadm kubectl --disableexcludes=kubernetes
dnf versionlock add kubelet kubeadm kubectl

# 重要：移除可能導致 v1.30+ kubelet 啟動失敗的過時參數設定檔
rm -f /etc/sysconfig/kubelet
systemctl enable --now kubelet

### ========= 4. 叢集初始化 (Kubeadm Init) =========
if [[ -f /etc/kubernetes/admin.conf ]]; then
    warn "偵測到已初始化的控制平面，略過 kubeadm init。"
else
    log "預拉 Kubernetes 映像檔"
    kubeadm config images pull --cri-socket=unix:///run/containerd/containerd.sock

    log "執行 kubeadm init"
    API_ADDR=$(ip -4 -o addr show scope global | awk '{print $4}' | cut -d/ -f1 | head -n1)
    kubeadm init \
      --kubernetes-version="v${K8S_VERSION}" \
      --pod-network-cidr="${POD_CIDR}" \
      --service-cidr="${SERVICE_CIDR}" \
      --apiserver-advertise-address="${API_ADDR}" \
      --cri-socket=unix:///run/containerd/containerd.sock
fi

### ========= 5. 配置 kubectl =========
log "配置 kubeconfig 給目前使用者"
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

### ========= 6. 安裝 Calico (Operator 模式) =========
install_calico(){
    log "安裝 Calico CRDs (使用 --server-side 避免長度過長報錯)"
    # 解決 metadata.annotations: Too long 錯誤的關鍵
    kubectl apply --server-side -f "https://raw.githubusercontent.com/projectcalico/calico/${CALICO_VERSION}/manifests/operator-crds.yaml"
    
    log "安裝 Calico Operator"
    kubectl apply --server-side -f "https://raw.githubusercontent.com/projectcalico/calico/${CALICO_VERSION}/manifests/tigera-operator.yaml"

    log "下載並配置 custom-resources.yaml (CIDR: ${POD_CIDR})"
    curl -fsSL -o custom-resources.yaml "https://raw.githubusercontent.com/projectcalico/calico/${CALICO_VERSION}/manifests/custom-resources.yaml"
    # 使用 # 作為 sed 分隔符以安全處理帶斜線的 CIDR
    sed -i "s#cidr: .*#cidr: ${POD_CIDR}#g" custom-resources.yaml
    
    log "套用自定義資源啟動網路組件"
    kubectl apply -f custom-resources.yaml

    log "等待 10 秒後檢查 Operator 狀態"
    sleep 10
    kubectl -n tigera-operator get pods
}

install_calico

### ========= 7. 完成輸出 =========
log "檢查節點狀態"
kubectl get nodes -o wide || true

log "輸出 Worker 節點加入命令："
kubeadm token create --print-join-command || true

warn "建議執行 'reboot' 以確保 SELinux disabled 與核心參數完全生效。"
log "✔ Kubernetes 控制平面安裝腳本執行完畢！"
