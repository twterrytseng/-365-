# worker node auto install

#!/usr/bin/env bash
set -euo pipefail

# === 變數設定 (須與控制平面一致) ===
K8S_RPM_BASEURL="https://pkgs.k8s.io/core:/stable:/v1.30/rpm/"
K8S_RPM_GPGKEY="https://pkgs.k8s.io/core:/stable:/v1.30/rpm/repodata/repomd.xml.key"
K8S_VERSION="1.30.0"

log(){ echo -e "\033[0;32m[INFO]\033[0m $*"; }
err(){ echo -e "\033[0;31m[ERR ]\033[0m $*"; exit 1; }

[[ "$(id -u)" -eq 0 ]] || err "請以 root 執行"

### ========= 1. 系統更新與工具安裝 =========
log "系統更新與安裝必要工具 (iproute-tc, chrony...)"
dnf -y update
dnf -y install dnf-plugins-core 'dnf-command(versionlock)' \
           curl wget bash-completion iproute iproute-tc jq tar chrony

systemctl enable --now chronyd || true

### ========= 2. 環境清理與核心設定 =========
log "停用 Swap, SELinux 與防火牆"
swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab
setenforce 0 || true
sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config

log "載入 Kernel 模組與 sysctl"
cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
modprobe overlay && modprobe br_netfilter

cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
sysctl --system
systemctl disable --now firewalld || true

### ========= 3. 安裝 containerd =========
log "安裝配置 containerd.io"
dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
dnf -y install containerd.io
mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml >/dev/null
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
systemctl restart containerd && systemctl enable containerd

### ========= 4. 安裝 K8s 組件並鎖定版本 =========
log "配置 Kubernetes Repo 並安裝"
cat <<EOF | tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=${K8S_RPM_BASEURL}
enabled=1
gpgcheck=1
gpgkey=${K8S_RPM_GPGKEY}
EOF

dnf -y install kubelet kubeadm kubectl --disableexcludes=kubernetes
dnf versionlock add kubelet kubeadm kubectl

# 重要修正：清除過時參數設定檔，確保 kubelet 正常啟動
rm -f /etc/sysconfig/kubelet
systemctl enable --now kubelet

log "✔ Worker 節點基礎環境準備完成！"
log "請在控制平面節點執行 'kubeadm token create --print-join-command' 獲取加入指令。"
